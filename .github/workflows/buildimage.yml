name: CI

on: [push]

jobs:
#  publishDockerImage:
#    name: Publish Docker build image
#    runs-on: ubuntu-20.04
#    steps:
#      - uses: actions/checkout@master
#        with:
#          submodules: true
#      - name: Publish to Github Packages registry
#        uses: elgohr/Publish-Docker-Github-Action@master
#        with:
#          name: docker.pkg.github.com/sauci/pokypi/build
#          username: ${{secrets.PKG_REGISTRY_USERNAME}}
#          password: ${{secrets.PKG_REGISTRY_RW_TOKEN}}
#          dockerfile: Dockerfile
#          registry: docker.pkg.github.com
  checkoutRepositories:
    name: Checkout repositories
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v1
        with:
          submodules: true
      - name: Download external layers
        run: git clone git://git.yoctoproject.org/meta-raspberrypi poky/meta-raspberrypi
      - name: Change permissions
        run: chmod -R 777 ${{ github.workspace }}
  buildLinuxImage:
    needs:
#      - publishDockerImage
      - checkoutRepositories
    name: Build Linux image
    runs-on: self-hosted
    container:
      image: crops/poky
#      credentials:
#        username: ${{secrets.PKG_REGISTRY_USERNAME}}
#        password: ${{secrets.PKG_REGISTRY_RW_TOKEN}}
      volumes:
        - ${{ github.workspace }}:/workdir
    steps:
#      - uses: actions/checkout@v1
#        with:
#          submodules: true
#      - name: Download external layers
#        run: |
#          git clone git://git.yoctoproject.org/meta-raspberrypi poky/meta-raspberrypi
#      - name: Initialize Bitbake configuration
#        run: cd poky && source ./oe-init-build-env ./../build
      - name: Build image using Bitbake
        run: cd poky && source ./oe-init-build-env ./../build && cd ../build && bitbake core-image-base
  uploadArtifacts:
    needs:
      - buildLinuxImage
    name: Upload artifacts
    runs-on: self-hosted
    steps:
      - uses: actions/upload-artifact@v2
        name: Upload all artifacts
        with:
          name: images
          path: build/tmp/images
#      - name: Clone Poky Thud repository
#        run: git clone -b thud git://git.yoctoproject.org/poky
#      - name: Clone Raspberry Pi layer
#        run: git clone -b thud git://git.yoctoproject.org/meta-raspberrypi
#      - name: Generate default build environment
#        run: docker run -v $(pwd):$(pwd) crops/poky --workdir=$(pwd) bash -c "cd poky && . $(pwd)/oe-init-build-env build"
#      - name: Setup modifications
#        run: cp ./bblayers.conf ./poky/build/conf/bblayers.conf && cp ./local.conf ./poky/build/conf/local.conf
#      - name: Build image
#        run: docker run -v $(pwd):$(pwd) crops/poky --workdir=$(pwd) bash -c "cd poky/build && bitbake core-image-base"
